
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>02 - Create predictive model for NYC Yellow Cab data set &#8212; NYC Yellow Cab Taxi Data Analysis</title>
    
  <link rel="stylesheet" href="_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.40e2e510f6b7d1648584402491bb10fe.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.d3f166471bb80abb5163.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.d31b09fe5c1d09cb49b26a786de4a05d.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="01 - Create descriptive statistics for NYC Yellow Cab data set" href="01_analyze-taxi.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="index.html">
  
  
  <h1 class="site-logo" id="site-title">NYC Yellow Cab Taxi Data Analysis</h1>
  
</a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="README.html">
   Using Coiled to explore, analyze and predict NYC Yellowcab taxi tips
  </a>
 </li>
</ul>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="00_explore-taxi.html">
   0 - Exploring the NYC Yellow taxi data set
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="01_analyze-taxi.html">
   01 - Create descriptive statistics for NYC Yellow Cab data set
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   02 - Create predictive model for NYC Yellow Cab data set
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/02_predict-taxi.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

        <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/cooperrc/nyc-taxi-coiled"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/cooperrc/nyc-taxi-coiled/issues/new?title=Issue%20on%20page%20%2F02_predict-taxi.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/cooperrc/nyc-taxi-coiled/master?urlpath=tree/02_predict-taxi.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#launch-a-coiled-cluster">
   Launch a Coiled cluster
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#create-data-predictions-in-the-cloud-linear-regression">
   Create data predictions in the cloud - Linear Regression
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-the-dask-dataframe">
     1. Create the Dask dataframe
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#partition-the-data-into-testing-and-training-sets">
     2. Partition the data into testing and training sets
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#perform-the-linear-regression-using-mean-and-compute">
     3. Perform the linear regression using
     <code class="docutils literal notranslate">
      <span class="pre">
       mean()
      </span>
     </code>
     and
     <code class="docutils literal notranslate">
      <span class="pre">
       compute()
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#mean-squared-error-in-2-parameter-model">
     Mean squared error in 2-parameter model
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#improving-the-model-by-including-more-measurements">
   Improving the model by including more measurements
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#train-the-model">
     1. Train the model
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-predicted-tips-on-a-subset">
     2. Plot the predicted tips on a subset
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#calculate-the-mse-for-the-xgboost-model">
     3. Calculate the MSE for the XGBoost model
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#wrapping-up">
   Wrapping up
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="create-predictive-model-for-nyc-yellow-cab-data-set">
<h1>02 - Create predictive model for NYC Yellow Cab data set<a class="headerlink" href="#create-predictive-model-for-nyc-yellow-cab-data-set" title="Permalink to this headline">¶</a></h1>
<p>In this notebook, you will</p>
<ul class="simple">
<li><p>Launch a <span class="xref myst">Coiled Cluster</span></p></li>
<li><p>Load a <a class="reference external" href="https://tutorial.dask.org/04_dataframe.html">Dask dataframe</a> into your workspace</p></li>
<li><p>partition data into training and testing sets</p></li>
<li><p>perform a linear least square regression with 2 independent variables</p></li>
<li><p>use <a class="reference external" href="https://xgboost.readthedocs.io/en/latest/tutorials/dask.html">xgboost</a> to train a machine learning model</p></li>
</ul>
<p>You will need</p>
<ul class="simple">
<li><p>Coiled</p></li>
<li><p>Dask</p></li>
<li><p>Dask-ML: a machine-learning library for Dask</p></li>
<li><p>NumPy</p></li>
<li><p>Matplotlib</p></li>
</ul>
<div class="section" id="launch-a-coiled-cluster">
<h2>Launch a Coiled cluster<a class="headerlink" href="#launch-a-coiled-cluster" title="Permalink to this headline">¶</a></h2>
<p>The first step is to spin up a Dask Cluster. In Coiled, this is done by creating a <code class="docutils literal notranslate"><span class="pre">coiled.Cluster</span></code> instance. You can use <a class="reference external" href="https://docs.coiled.io/user_guide/api.html#coiled.Cluster">keyword arguments</a> to specify the details of your cluster further. Please read the <a class="reference external" href="https://docs.coiled.io/user_guide/cluster_creation.html">cluster creation documentation</a> to know more.</p>
<p>Give a name to this cluster, if you don’t specify this keyword argument, clusters will be given a unique randomly generated name.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">coiled</span>
</pre></div>
</div>
</div>
</div>
<p>The predictive analysis will use <a class="reference external" href="https://xgboost.readthedocs.io/en/latest/tutorials/dask.html">xgboost</a>, so you can create a Coiled software environment using the following command in iPython or Jupyter.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">coiled</span>
<span class="n">coiled</span><span class="o">.</span><span class="n">create_software_environment</span><span class="p">(</span>
   <span class="n">name</span><span class="o">=</span><span class="s2">&quot;xgboost-on-coiled&quot;</span><span class="p">,</span>
   <span class="n">conda</span><span class="o">=</span><span class="p">{</span>
      <span class="s2">&quot;channels&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;conda-forge&quot;</span>
      <span class="p">],</span>
      <span class="s2">&quot;dependencies&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;coiled&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dask-ml&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dask&gt;=2.23.0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fastparquet&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pandas&gt;=1.1.0&quot;</span><span class="p">,</span>
        <span class="s2">&quot;python-snappy&quot;</span><span class="p">,</span>
        <span class="s2">&quot;s3fs&quot;</span><span class="p">,</span>
        <span class="s2">&quot;scikit-learn&quot;</span><span class="p">,</span>
        <span class="s2">&quot;xgboost&gt;=1.3.0&quot;</span>
      <span class="p">]</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<p>This creates a container with xgboost and a few other dependencies. You can open the cluster with your new software environment with the <code class="docutils literal notranslate"><span class="pre">coiled.Cluster</span></code> command and specify <code class="docutils literal notranslate"><span class="pre">software</span> <span class="pre">=</span> <span class="pre">&lt;username&gt;/xgboost-on-coiled</span></code>. Now, you can define the client to access the cluster.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># cluster = coiled.Cluster(name=&quot;taxi-predict&quot;, n_workers=10)</span>
<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="n">cluster</span> <span class="o">=</span> <span class="n">coiled</span><span class="o">.</span><span class="n">Cluster</span><span class="p">(</span><span class="n">n_workers</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">software</span><span class="o">=</span><span class="s1">&#39;cooperrc/xgboost-on-coiled&#39;</span><span class="p">)</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "", "version_major": 2, "version_minor": 0}
</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Found software environment build
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/ryan/.conda/envs/coiledcloud/lib/python3.9/site-packages/coiled/cluster.py:629: UserWarning: Unable to locate credentials
  warnings.warn(str(e))
</pre></div>
</div>
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"></pre>
</div></div>
</div>
<p>Once the cluster is created (you can see the status on your <a class="reference external" href="https://cloud.coiled.io/">Coiled dashboard</a>), you can connect Dask to the cluster by creating a <code class="docutils literal notranslate"><span class="pre">distributed.Client</span></code> instance.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">client</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table style="border: 2px solid white;">
<tr>
<td style="vertical-align: top; border: 0px solid white">
<h3 style="text-align: left;">Client</h3>
<ul style="text-align: left; list-style: none; margin: 0; padding: 0;">
  <li><b>Scheduler: </b>tls://ec2-100-26-42-77.compute-1.amazonaws.com:8786</li>
  <li><b>Dashboard: </b><a href='http://ec2-100-26-42-77.compute-1.amazonaws.com:8787' target='_blank'>http://ec2-100-26-42-77.compute-1.amazonaws.com:8787</a></li>
</ul>
</td>
<td style="vertical-align: top; border: 0px solid white">
<h3 style="text-align: left;">Cluster</h3>
<ul style="text-align: left; list-style:none; margin: 0; padding: 0;">
  <li><b>Workers: </b>10</li>
  <li><b>Cores: </b>20</li>
  <li><b>Memory: </b>80.00 GiB</li>
</ul>
</td>
</tr>
</table></div></div>
</div>
</div>
<div class="section" id="create-data-predictions-in-the-cloud-linear-regression">
<h2>Create data predictions in the cloud - Linear Regression<a class="headerlink" href="#create-data-predictions-in-the-cloud-linear-regression" title="Permalink to this headline">¶</a></h2>
<p>Now that you have a cluster running and Dask connected to it, do some computations. This example will run the computations on about 84 million rows. You will create a prediction in 3 steps:</p>
<ol class="simple">
<li><p>create the Dask dataframe and select the independent variables</p></li>
<li><p>partition the data into testing and training sets</p></li>
<li><p>perform the linear regression using <code class="docutils literal notranslate"><span class="pre">mean()</span></code> and <code class="docutils literal notranslate"><span class="pre">compute()</span></code></p></li>
</ol>
<div class="section" id="create-the-dask-dataframe">
<h3>1. Create the Dask dataframe<a class="headerlink" href="#create-the-dask-dataframe" title="Permalink to this headline">¶</a></h3>
<p>Here, you load the data into a Dask dataframe from AWS.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dask.dataframe</span> <span class="k">as</span> <span class="nn">dd</span>

<span class="n">taxi_full</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="s2">&quot;s3://nyc-tlc/trip data/yellow_tripdata_2019-*.csv&quot;</span><span class="p">,</span>
    <span class="n">dtype</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;payment_type&quot;</span><span class="p">:</span> <span class="s2">&quot;float64&quot;</span><span class="p">,</span>
        <span class="s2">&quot;VendorID&quot;</span><span class="p">:</span> <span class="s2">&quot;float64&quot;</span><span class="p">,</span>
        <span class="s2">&quot;passenger_count&quot;</span><span class="p">:</span> <span class="s2">&quot;float64&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RatecodeID&quot;</span><span class="p">:</span> <span class="s2">&quot;float64&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">storage_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;anon&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
    <span class="n">blocksize</span><span class="o">=</span><span class="s2">&quot;16 MiB&quot;</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">persist</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Now, you can remove the data that you found was unnecessary in the previous notebook, [01_Create descriptive statistics for NYC Yellow Cab data set](./Create descriptive statistics for NYC Yellow Cab data set). Save the variable as <code class="docutils literal notranslate"><span class="pre">taxi_full_wtips</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">taxi_full_wtips</span> <span class="o">=</span> <span class="n">taxi_full</span><span class="p">[(</span><span class="n">taxi_full</span><span class="p">[</span><span class="s1">&#39;tip_amount&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> 
                            <span class="p">(</span><span class="n">taxi_full</span><span class="p">[</span><span class="s1">&#39;fare_amount&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> 
                            <span class="p">(</span><span class="n">taxi_full</span><span class="p">[</span><span class="s1">&#39;trip_distance&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">persist</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="partition-the-data-into-testing-and-training-sets">
<h3>2. Partition the data into testing and training sets<a class="headerlink" href="#partition-the-data-into-testing-and-training-sets" title="Permalink to this headline">¶</a></h3>
<p>Load the <code class="docutils literal notranslate"><span class="pre">model_selection</span></code> library from Dask-ML. You will use this function to split the data into training and testing dataframes. The <code class="docutils literal notranslate"><span class="pre">X</span></code> variable holds all of the data except for <code class="docutils literal notranslate"><span class="pre">tip_amount</span></code>. The <code class="docutils literal notranslate"><span class="pre">y</span></code> variable is the <code class="docutils literal notranslate"><span class="pre">tip_amount</span></code>, your observations for predictions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dask</span>
<span class="kn">from</span> <span class="nn">dask_ml.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">taxi_full_wtips</span><span class="p">[[</span><span class="s1">&#39;passenger_count&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;trip_distance&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;RatecodeID&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;PULocationID&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;DOLocationID&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;payment_type&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;fare_amount&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;extra&#39;</span><span class="p">,</span>  
                            <span class="s1">&#39;tolls_amount&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;total_amount&#39;</span><span class="p">]]</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">taxi_full_wtips</span><span class="p">[</span><span class="s1">&#39;tip_amount&#39;</span><span class="p">]</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">shuffle</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">persist</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;passenger_count&#39;, &#39;trip_distance&#39;, &#39;RatecodeID&#39;, &#39;PULocationID&#39;,
       &#39;DOLocationID&#39;, &#39;payment_type&#39;, &#39;fare_amount&#39;, &#39;extra&#39;, &#39;tolls_amount&#39;,
       &#39;total_amount&#39;],
      dtype=&#39;object&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="s1">&#39;fare_amount&#39;</span><span class="p">],</span> <span class="n">X_train</span><span class="p">[</span><span class="s1">&#39;trip_distance&#39;</span><span class="p">],</span> <span class="n">y_train</span>

<span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">persist</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="perform-the-linear-regression-using-mean-and-compute">
<h3>3. Perform the linear regression using <code class="docutils literal notranslate"><span class="pre">mean()</span></code> and <code class="docutils literal notranslate"><span class="pre">compute()</span></code><a class="headerlink" href="#perform-the-linear-regression-using-mean-and-compute" title="Permalink to this headline">¶</a></h3>
<p>Linear regression minimizes the sum of squares error between a linear function of  dependent variables,</p>
<p><span class="math notranslate nohighlight">\(f(x_1,~x_2) = \beta + \alpha_1 x_1 + \alpha_2 x_2\)</span></p>
<p><span class="math notranslate nohighlight">\(\min(\sum|y - f(x_1,~x_2)|^2)\)</span></p>
<p>where</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\beta = offset\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(x_1 = fare~amount\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(x_2 = trip~distance\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(y_1 = tip~amount\)</span></p></li>
</ul>
<p>These equations reduce to a single linear algebra equation as such</p>
<p><span class="math notranslate nohighlight">\(\mathbf{Z}^T\mathbf{Z a} = \mathbf{Z}^T\mathbf{y}\)</span></p>
<p><span class="math notranslate nohighlight">\(\left[\begin{array}
~1 &amp; \sum x_1/N &amp; \sum x_2/N \\
\sum x_1/N &amp; \sum x_1^2/N &amp; \sum x_1x_2/N \\
\sum x_2/N &amp;\sum x_1 x_2/N &amp; ~\sum x_2^2/N \end{array}\right]\)</span> = <span class="math notranslate nohighlight">\(
\left[\begin{array}
\sum y/N\\
\sum x_1 y/N\\
\sum x_2 y/N\\
\end{array}\right]\)</span></p>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">mean().compute()</span></code> command to calculate this matrix-vector equation. The result is a <span class="math notranslate nohighlight">\(3 \times 3\)</span> array, <code class="docutils literal notranslate"><span class="pre">ZTZ</span></code>, and a vector of length 3, <code class="docutils literal notranslate"><span class="pre">ZTy</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Sx1</span> <span class="o">=</span> <span class="n">x1</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">Sx2</span> <span class="o">=</span> <span class="n">x2</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Sx1x2</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="o">*</span><span class="n">x2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">Sx1x1</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">Sx2x2</span> <span class="o">=</span> <span class="p">(</span><span class="n">x2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">ZTZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="n">Sx1</span><span class="p">,</span> <span class="n">Sx2</span><span class="p">],</span> 
                <span class="p">[</span><span class="n">Sx1</span><span class="p">,</span> <span class="n">Sx1x1</span><span class="p">,</span> <span class="n">Sx1x2</span><span class="p">],</span>
                <span class="p">[</span><span class="n">Sx2</span><span class="p">,</span> <span class="n">Sx1x2</span><span class="p">,</span> <span class="n">Sx2x2</span><span class="p">]])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Sy</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">Sx1y</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="o">*</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">Sx2y</span> <span class="o">=</span> <span class="p">(</span><span class="n">x2</span><span class="o">*</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Now, you have the calculated each array value. You can solve the linear least square problem and calculate <span class="math notranslate nohighlight">\([\beta,~\alpha_1,~\alpha_2]\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ZTy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Sy</span><span class="p">,</span> <span class="n">Sx1y</span><span class="p">,</span> <span class="n">Sx2y</span><span class="p">])</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">ZTZ</span><span class="p">,</span> <span class="n">ZTy</span><span class="p">)</span>
<span class="n">A</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([0.6119274 , 0.176382  , 0.07317207])
</pre></div>
</div>
</div>
</div>
<p>The result is that the predicted tip from this data set is:</p>
<p><span class="math notranslate nohighlight">\(tip = \$0.61 + 0.18\cdot (\$total~fare) + 0.07\frac{\$}{mi}(trip~distance [mi])\)</span></p>
<p>You can use the subset of data from <a class="reference internal" href="00_explore-taxi.html"><span class="doc std std-doc">0 - Exploring the NYC Yellow taxi data set</span></a> to visually inspect the model.</p>
<p>Import Matplotlib and Pandas. Then, apply the same filter to the data to remove 0’s.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;fivethirtyeight&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">taxi_subset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;./yellow_tripdata_2019-01_0-end-by-1000.csv&#39;</span><span class="p">)</span>
<span class="n">taxi_subset</span> <span class="o">=</span> <span class="n">taxi_subset</span><span class="p">[(</span><span class="n">taxi_subset</span><span class="p">[</span><span class="s1">&#39;tip_amount&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> 
                        <span class="p">(</span><span class="n">taxi_subset</span><span class="p">[</span><span class="s1">&#39;fare_amount&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> 
                        <span class="p">(</span><span class="n">taxi_subset</span><span class="p">[</span><span class="s1">&#39;trip_distance&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>Now, you can apply your data to the <code class="docutils literal notranslate"><span class="pre">taxi_subset</span></code> dataframe. You can directly plug in the equation from above as such</p>
<p><code class="docutils literal notranslate"><span class="pre">predicted_tip</span> <span class="pre">=</span> <span class="pre">A[0]+A[1]*taxi_subset['fare_amount']+A[2]*taxi_subset['trip_distance']</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">taxi_subset</span><span class="p">[</span><span class="s1">&#39;fare_amount&#39;</span><span class="p">],</span> <span class="n">taxi_subset</span><span class="p">[</span><span class="s1">&#39;tip_amount&#39;</span><span class="p">],</span> 
         <span class="s1">&#39;bo&#39;</span><span class="p">,</span> 
        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;measured data&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">taxi_subset</span><span class="p">[</span><span class="s1">&#39;fare_amount&#39;</span><span class="p">],</span> 
         <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">taxi_subset</span><span class="p">[</span><span class="s1">&#39;fare_amount&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">taxi_subset</span><span class="p">[</span><span class="s1">&#39;trip_distance&#39;</span><span class="p">],</span> 
         <span class="s1">&#39;rs&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;2-parameter LSE&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;total fare ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;tip ($)&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/02_predict-taxi_25_0.png" src="_images/02_predict-taxi_25_0.png" />
</div>
</div>
</div>
<div class="section" id="mean-squared-error-in-2-parameter-model">
<h3>Mean squared error in 2-parameter model<a class="headerlink" href="#mean-squared-error-in-2-parameter-model" title="Permalink to this headline">¶</a></h3>
<p>The model captures the overall trend between tips and fare amounts, but there is variation that was not captured by the model. Here, calculate the <a class="reference external" href="https://en.wikipedia.org/wiki/Mean_squared_error">mean squared error</a> (MSE) to quantify the variance not captured by the current model</p>
<p><span class="math notranslate nohighlight">\(MSE = \frac{\sum_1^N (y_{test} - y_{predict})^2}{N} = \frac{\sum_1^N (y_{test} - \$0.61 - 0.18\cdot (\$total~fare) - 0.07\frac{\$}{mi}(trip~distance [mi]))^2}{N}\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">MSE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">y_test</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y_test</span> <span class="o">-</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">X_test</span><span class="p">[</span><span class="s1">&#39;fare_amount&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">X_test</span><span class="p">[</span><span class="s1">&#39;trip_distance&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">MSE</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.503489841743055
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="improving-the-model-by-including-more-measurements">
<h2>Improving the model by including more measurements<a class="headerlink" href="#improving-the-model-by-including-more-measurements" title="Permalink to this headline">¶</a></h2>
<p>The current regression model only uses fare amount and trip distance to predict the taxi driver tip per trip. You can reduce the mean squared error (MSE) by including more measurements e.g.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">VendorID</span></code>: A code indicating the TPEP provider that provided the record.
1= Creative Mobile Technologies, LLC; 2= VeriFone Inc.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tpep_pickup_datetime</span></code>: The date and time when the meter was engaged.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tpep_dropoff_datetime</span></code>: The date and time when the meter was disengaged.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Passenger_count</span></code>: The number of passengers in the vehicle.
This is a driver-entered value.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Trip_distance</span></code>: The elapsed trip distance in miles reported by the taximeter.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PULocationID</span></code>: TLC Taxi Zone in which the taximeter was engaged</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DOLocationID</span></code>: TLC Taxi Zone in which the taximeter was disengaged</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RateCodeID</span></code>: The final rate code in effect at the end of the trip.
1= Standard rate
2=JFK
3=Newark
4=Nassau or Westchester
5=Negotiated fare
6=Group ride</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Payment_type</span></code>: A numeric code signifying how the passenger paid for the trip.
1= Credit card
2= Cash
3= No charge
4= Dispute
5= Unknown
6= Voided trip</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Fare_amount</span></code>: The time-and-distance fare calculated by the meter.
Extra Miscellaneous extras and surcharges. Currently, this only includes
the <span class="math notranslate nohighlight">\(\$0.50\)</span> and <span class="math notranslate nohighlight">\(\$1\)</span> rush hour and overnight charges.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Tolls_amount</span></code>: Total amount of all tolls paid in trip.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Total_amount</span></code>: The total amount charged to passengers. Does not include cash tips.</p></li>
</ul>
<p>Here, you will use <a class="reference external" href="https://xgboost.readthedocs.io/en/latest/index.html">XGBoost</a> to complete a regression analysis.</p>
<ol class="simple">
<li><p>train the model with the training data set</p></li>
<li><p>plot the predicted response on the subset of data</p></li>
<li><p>calculate the mean squared error for XGBoost test data</p></li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xgboost</span> <span class="k">as</span> <span class="nn">xgb</span>
<span class="n">dtrain</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">dask</span><span class="o">.</span><span class="n">DaskDMatrix</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="train-the-model">
<h3>1. Train the model<a class="headerlink" href="#train-the-model" title="Permalink to this headline">¶</a></h3>
<p>Here, you use the Coiled <code class="docutils literal notranslate"><span class="pre">client</span></code> to train the model using 12 measurements described above. The <code class="docutils literal notranslate"><span class="pre">output</span></code> variable is the result of the <a class="reference external" href="https://xgboost.readthedocs.io/en/latest/tutorials/dask.html#other-customization"><code class="docutils literal notranslate"><span class="pre">xgboost.dask.train</span></code></a>. Here, you will build a model with</p>
<ul class="simple">
<li><p>regression and squared error loss <code class="docutils literal notranslate"><span class="pre">reg:squarederror</span></code></p></li>
<li><p>the maximum tree depth of 6 <code class="docutils literal notranslate"><span class="pre">'max_depth':</span> <span class="pre">6</span></code></p></li>
<li><p>categorical data enabled <code class="docutils literal notranslate"><span class="pre">'enable_categorical':</span> <span class="pre">True</span></code></p></li>
<li><p>10 boosting rounds <code class="docutils literal notranslate"><span class="pre">num_boost_round=10</span></code></p></li>
<li><p>training data set to <code class="docutils literal notranslate"><span class="pre">X_train</span></code> and <code class="docutils literal notranslate"><span class="pre">y_train</span></code> contained in the <code class="docutils literal notranslate"><span class="pre">dtrain</span></code> variable</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">dask</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
    <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span>
    <span class="n">params</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;objective&#39;</span><span class="p">:</span> <span class="s1">&#39;reg:squarederror&#39;</span><span class="p">,</span>
        <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s1">&#39;enable_categorical&#39;</span><span class="p">:</span> <span class="kc">True</span>
    <span class="p">},</span>
    <span class="n">dtrain</span><span class="o">=</span><span class="n">dtrain</span><span class="p">,</span>
    <span class="n">num_boost_round</span><span class="o">=</span><span class="mi">10</span>
<span class="c1">#     evals=[(dtrain, &#39;train&#39;)]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="plot-the-predicted-tips-on-a-subset">
<h3>2. Plot the predicted tips on a subset<a class="headerlink" href="#plot-the-predicted-tips-on-a-subset" title="Permalink to this headline">¶</a></h3>
<p>Now, the model has been trained with XGBoost. You can use the <code class="docutils literal notranslate"><span class="pre">taxi_subset</span></code> imported from <code class="docutils literal notranslate"><span class="pre">yellow_tripdata_2019-01_0-end-by-1000.csv</span></code> to plot a subset of the data.</p>
<ul class="simple">
<li><p>convert the Pandas dataframe to a Dask dataframe with <code class="docutils literal notranslate"><span class="pre">dask.dataframe.from_pandas</span></code></p></li>
<li><p>build the XGBoost Dask Matrix as above for the training data with <code class="docutils literal notranslate"><span class="pre">xgb.dask.DaskMatrix</span></code></p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dask</span> <span class="kn">import</span> <span class="n">dataframe</span> <span class="k">as</span> <span class="n">dd</span>
<span class="n">X_subset</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">taxi_subset</span><span class="p">[[</span><span class="s1">&#39;passenger_count&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;trip_distance&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;RatecodeID&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;PULocationID&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;DOLocationID&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;payment_type&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;fare_amount&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;extra&#39;</span><span class="p">,</span>  
                            <span class="s1">&#39;tolls_amount&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;total_amount&#39;</span><span class="p">]],</span> <span class="n">npartitions</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">y_subset</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">taxi_subset</span><span class="p">[</span><span class="s1">&#39;tip_amount&#39;</span><span class="p">],</span> <span class="n">npartitions</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">dsubset</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">dask</span><span class="o">.</span><span class="n">DaskDMatrix</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">X_subset</span><span class="p">,</span> <span class="n">y_subset</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, you can use the Dask dataframe as input for the regression model using the <code class="docutils literal notranslate"><span class="pre">xgb.dask.predict</span></code> as such</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_subset_predict</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">dask</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;booster&#39;</span><span class="p">],</span> <span class="n">dsubset</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, you can plot the results. Here, you can compare the 2-parameter regression model to the 12-parameter XGBoost model. You capture much more of the variation in the tips with the new model</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X_subset</span><span class="p">[</span><span class="s1">&#39;fare_amount&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span> <span class="n">y_subset</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span> 
         <span class="s1">&#39;o&#39;</span><span class="p">,</span> 
        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;measured data&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">taxi_subset</span><span class="p">[</span><span class="s1">&#39;fare_amount&#39;</span><span class="p">],</span> 
         <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">taxi_subset</span><span class="p">[</span><span class="s1">&#39;fare_amount&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">taxi_subset</span><span class="p">[</span><span class="s1">&#39;trip_distance&#39;</span><span class="p">],</span> 
         <span class="s1">&#39;rs&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;2-parameter LSE&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X_subset</span><span class="p">[</span><span class="s1">&#39;fare_amount&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span> <span class="n">y_subset_predict</span><span class="o">.</span><span class="n">compute</span><span class="p">(),</span> 
         <span class="s1">&#39;k*&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;XGBoost model&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;total fare ($)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;tip ($)&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/02_predict-taxi_37_0.png" src="_images/02_predict-taxi_37_0.png" />
</div>
</div>
</div>
<div class="section" id="calculate-the-mse-for-the-xgboost-model">
<h3>3. Calculate the MSE for the XGBoost model<a class="headerlink" href="#calculate-the-mse-for-the-xgboost-model" title="Permalink to this headline">¶</a></h3>
<p>The 2-parameter LSE model had <span class="math notranslate nohighlight">\(MSE = (\$)^2 2.5\)</span>. The 12-parameter XGBoost model should reduce this MSE. First, use the booster model to predict the tips using <code class="docutils literal notranslate"><span class="pre">xgb.dask.predict</span></code> on the <code class="docutils literal notranslate"><span class="pre">X_test</span></code> data. Then, compute the average <code class="docutils literal notranslate"><span class="pre">sum()</span></code> of the squared errors.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prediction</span> <span class="o">=</span> <span class="n">xgb</span><span class="o">.</span><span class="n">dask</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;booster&#39;</span><span class="p">],</span> <span class="n">X_test</span><span class="p">)</span>
<span class="n">MSE_w_xgb</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">prediction</span> <span class="o">-</span> <span class="n">y_test</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">MSE_w_xgb</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.910368403467699
</pre></div>
</div>
</div>
</div>
<p>You reduced the MSE from <span class="math notranslate nohighlight">\((\$)^2 2.50\rightarrow(\$)^2 1.91\)</span>, congratulations! There are many other factors that can play an important role in the tips, but you built a model that can use the NYC Yellow Cab taxi data set to predict driver tips using distances, fares, passenger count, pickup and dropoff IDs, and toll amounts. You can play with the parameters to reduce the error in the test data</p>
</div>
</div>
<div class="section" id="wrapping-up">
<h2>Wrapping up<a class="headerlink" href="#wrapping-up" title="Permalink to this headline">¶</a></h2>
<p>In this notebook, you created a prediction for taxi driver tips based upon over 84 million taxi rides in NYC. You</p>
<ul class="simple">
<li><p>loaded the NYC Yellow Cab data set into Dask dataframe on a Coiled cluster</p></li>
<li><p>created a 2-parameter least squares error model using some <code class="docutils literal notranslate"><span class="pre">compute()</span></code> commands and linear algebra</p></li>
<li><p>created a 12-parameter XGBoost squared error regression model</p></li>
<li><p>reduced the mean squared error (MSE) going from 2-parameters to 12-parameters</p></li>
<li><p>plotted subsets of the NYC Yellow Cab taxi data set and the model predictions</p></li>
</ul>
<p>Next steps: go try Coiled and build some new models or try new data!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coiled</span><span class="o">.</span><span class="n">delete_cluster</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;taxi-predict&quot;</span><span class="p">)</span>
<span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #008000; text-decoration-color: #008000">Cluster deleted successfully.</span>
</pre>
</div></div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="01_analyze-taxi.html" title="previous page">01 - Create descriptive statistics for NYC Yellow Cab data set</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Ryan C. Cooper<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="_static/js/index.d3f166471bb80abb5163.js"></script>


    
  </body>
</html>